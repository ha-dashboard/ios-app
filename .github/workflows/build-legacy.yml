name: Build Legacy (iPad 2)

on:
  push:
    tags: ['v*']

env:
  TEAM_ID: ${{ vars.TEAM_ID }}

jobs:
  build-legacy:
    runs-on: macos-15
    timeout-minutes: 90
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h /
          # Remove Xcodes we don't need (keep 26.2 for xcodegen)
          sudo rm -rf /Applications/Xcode_16.0.app \
                      /Applications/Xcode_16.1.app \
                      /Applications/Xcode_16.3.app \
                      /Applications/Xcode_16.4.app 2>/dev/null || true
          echo "After cleanup:"
          df -h /

      - name: Cache Xcode 13.2.1 .xip
        id: xcode-cache
        uses: actions/cache@v4
        with:
          path: ~/.xcodes/Downloads
          key: xcode-13.2.1-xip

      - name: Install Xcode 13.2.1
        env:
          FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
          XCODES_USERNAME: ${{ secrets.XCODES_USERNAME }}
        run: |
          if [ -d "/Applications/Xcode-13.2.1.app" ]; then
            echo "Xcode 13.2.1 already installed."
          elif [ "${{ steps.xcode-cache.outputs.cache-hit }}" == "true" ]; then
            echo "Cache hit — extracting from cached .xip..."
            ls -lh ~/.xcodes/Downloads/
            xcodes install 13.2.1 --experimental-unxip --no-superuser
            ls /Applications/Xcode*13* 2>/dev/null || true
            echo "Xcode 13.2.1 installed from cache."
          else
            echo "No cache — downloading and installing Xcode 13.2.1..."
            mkdir -p ~/.xcodes/Downloads
            xcodes install 13.2.1 --use-fastlane-auth --experimental-unxip --no-superuser
            ls /Applications/Xcode*13* 2>/dev/null || true
            echo "Xcode 13.2.1 installed and .xip cached for next run."
          fi

      - name: Set version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION (build $BUILD_NUMBER)"

      - name: Install XcodeGen and generate project
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app
          brew install xcodegen
          # Inject Team ID into project.yml before generation
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"$TEAM_ID\"/" project.yml
          xcodegen generate --spec project.yml

      - name: Decode ASC API key
        env:
          ASC_KEY_BASE64: ${{ secrets.ASC_KEY_BASE64 }}
        run: |
          mkdir -p "$RUNNER_TEMP/private_keys"
          echo -n "$ASC_KEY_BASE64" | base64 --decode > "$RUNNER_TEMP/private_keys/AuthKey.p8"

      - name: Build with Xcode 13.2.1
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BUILD_NUMBER=${{ steps.version.outputs.build_number }}

          # Find the Xcode 13 installation (xcodes may name it differently)
          XCODE13=$(ls -d /Applications/Xcode*13.2.1* 2>/dev/null | head -1)
          if [ -z "$XCODE13" ]; then
            echo "Xcode 13.2.1 not found!"
            ls /Applications/Xcode* 2>/dev/null
            exit 1
          fi
          echo "Using $XCODE13"

          # Xcode 13.2.1's actool crashes on macOS 15, so skip asset catalog
          DEVELOPER_DIR="$XCODE13/Contents/Developer" xcodebuild \
            -project HADashboard.xcodeproj \
            -target HADashboard \
            -sdk iphoneos \
            -configuration Release \
            IPHONEOS_DEPLOYMENT_TARGET=9.0 \
            "ARCHS=armv7 arm64" \
            "VALID_ARCHS=armv7 arm64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_STYLE=Automatic \
            "DEVELOPMENT_TEAM=$TEAM_ID" \
            CODE_SIGN_IDENTITY="Apple Development" \
            "MARKETING_VERSION=$VERSION" \
            "CURRENT_PROJECT_VERSION=$BUILD_NUMBER" \
            "INFOPLIST_KEY_UIRequiredDeviceCapabilities=armv7" \
            ASSETCATALOG_COMPILER_APPICON_NAME="" \
            -authenticationKeyPath "$RUNNER_TEMP/private_keys/AuthKey.p8" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -allowProvisioningUpdates \
            build

      - name: Package IPA
        run: |
          VERSION=${{ steps.version.outputs.version }}
          APP="build/Release-iphoneos/HA Dashboard.app"

          if [ ! -d "$APP" ]; then
            echo "Build failed — .app not found"
            exit 1
          fi

          mkdir -p build/legacy/Payload
          cp -r "$APP" "build/legacy/Payload/"
          cd build/legacy
          zip -qr "HADashboard-${VERSION}-legacy-armv7-arm64.ipa" Payload/
          rm -rf Payload/
          cd ../..

          echo "IPA: build/legacy/HADashboard-${VERSION}-legacy-armv7-arm64.ipa"
          ls -lh "build/legacy/HADashboard-${VERSION}-legacy-armv7-arm64.ipa"

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          IPA="build/legacy/HADashboard-${VERSION}-legacy-armv7-arm64.ipa"

          # Try to upload to existing release, or create one
          gh release upload "v${VERSION}" "$IPA" --clobber 2>/dev/null || \
          gh release create "v${VERSION}" "$IPA" --generate-notes --title "v${VERSION}"

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$RUNNER_TEMP/private_keys"
